# 缓存穿透、击穿、雪崩

##### 什么是缓存穿透，如何解决

**缓存穿透：**

如果查询一个一定不存在的数据，比如黑客用一个不存在的id发起攻击，此时由于在缓存中查询不到对应的key，就会进入DB层进行查询。如果数据存在，我们的解决方案应该是在这个时候写缓存。这里因为数据必然不存在，那么如果频繁请求的话，会造成DB层查询压力加大，引起宕机。

**解决方案：**

1、将这些值设置为null，放到缓存中，查询对应的key时返回null。同时需要加过期时间，防止数据真的存在。

2、使用BloomFilter：布隆过滤器是一个不太精确的set结构，如果值存在，那么这个值可能不存在过滤器中，如果值不存在，那么就一定不存在。可以在查询缓存前，设置一层布隆过滤器，如果key存在，那么取查询对应缓存，缓存不存在查询对应的key。如果值不存在，直接返回。

**如何选择：**

1、针对恶意攻击，使用第一种方案会缓存大量无用的key，这个时候可以先使用第二种情况过滤到大部分key。

2、对于空数据有限，重复率高的，使用第一种情况比较合适。



##### 什么是缓存击穿，如何解决？

**缓存击穿**

在高并发的系统中，大量的请求同事查询一个key，如果这个key失效了，那么会在同一时刻大量请求走到DB层去进行查询，造成DB压力陡增。

**解决方案**

可以使用互斥锁来规避这个问题，每一进程在查询前需要获取到资源锁。这样在第一个进程在获取互斥锁之后，发现缓存失效，那么会进行DB查询，然后把数据写入到缓存，后续的进程在查询时就可以直接从缓存返回了。



##### 什么是缓存雪崩

某一个时刻发生大规模缓存失效的行为，比如缓存服务器宕机了。此时如果有高并发请求，那么会将大量请求达到数据库层，引发数据库宕机。

解决方案：

1、雪崩前：使用redis集群的设计方案，实现缓存的高可用。比如可以使用Redis Cluster来避免全部缓存失效。

2、雪崩中：使用限流&降级方案。如果缓存没查到，请求需要走降级组件，比如每秒支持2000请求的能力，多余的请求走降级组件，友好提示用户。

3、雪崩后：使用redis持久化的数据，尽快回复缓存集群。



##### 热点数据失效问题

热点数据必然是大量请求会请求的数据，如果热点数据因为缓存时间失效，大量请求进入数据库层面，会引起DB层崩溃。

**解决方案**

1、在设置过期时间时，在一个基础时间上，加一个范围内的随机值。

2、互斥锁。使用互斥锁会造成吞吐量的下降，需要结合业务的实际场景来使用。

